<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Venture Builders Fund Research Tool">
    <title>VBF Research Tool - Venture Builders Fund</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-light);
            padding: var(--spacing-md);
        }
        .login-box {
            background: white;
            padding: var(--spacing-xl);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .login-box h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: var(--spacing-xs);
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .research-content {
            display: none;
        }
        .research-content.active {
            display: block;
        }
        .stats-grid-research {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        .stat-card-research {
            background: white;
            padding: var(--spacing-sm);
            border-radius: 8px;
            border: 1px solid var(--color-border);
            text-align: center;
        }
        .stat-card-research p:first-child {
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.25rem;
        }
        .stat-card-research p:last-child {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }
        .research-controls {
            background: white;
            padding: var(--spacing-md);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-md);
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--color-bg-light);
            border-radius: 6px;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--color-accent);
            transition: width 0.3s;
        }
        .results-list {
            max-height: 500px;
            overflow-y: auto;
            background: white;
            padding: var(--spacing-md);
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }
        .result-item {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
        }
        .result-item:hover {
            background: var(--color-bg-light);
        }
        .result-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }
        .score-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .score-high { background: #d1fae5; color: #065f46; }
        .score-medium { background: #dbeafe; color: #1e40af; }
        .score-low { background: #fef3c7; color: #92400e; }
        .score-very-low { background: #fed7aa; color: #9a3412; }
        .score-none { background: #f3f4f6; color: #374151; }
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9375rem;
        }
        .btn-primary-research {
            background: var(--color-accent);
            color: white;
        }
        .btn-primary-research:hover {
            background: #1d4ed8;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .status-message {
            padding: var(--spacing-sm);
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            color: #1e40af;
            margin-top: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="images/logo-vbf.png" alt="Venture Builders Fund" class="logo-image">
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#" onclick="showOpalSection(); return false;">Opal Analysis</a></li>
            </ul>
        </div>
    </nav>

    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>VBF Research Tool</h2>
            <p style="text-align: center; color: var(--color-text-light); margin-bottom: var(--spacing-md);">Please sign in to access the research tool</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="error-message" id="errorMessage"></div>
                <button type="submit" class="btn-primary-research" style="width: 100%;">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Research Content -->
    <div id="researchContent" class="research-content" style="margin-top: 80px; padding: var(--spacing-md);">
        <div class="container" style="max-width: 1400px;">
            <div style="background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); border-radius: 12px; padding: var(--spacing-lg); color: white; margin-bottom: var(--spacing-md);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem;">Venture Builder Fund Research</h1>
                        <p style="opacity: 0.9; font-size: 0.875rem;">Ref-Based Index ‚Ä¢ No Race Conditions ‚Ä¢ Reliable Progress</p>
                    </div>
                    <button id="resetBtn" onclick="resetTool()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 8px; display: none;">
                        Reset
                    </button>
                </div>
            </div>

            <!-- Data Loading Section -->
            <div id="dataLoadingSection" style="background: white; border-radius: 12px; padding: var(--spacing-lg); border: 1px solid var(--color-border); margin-bottom: var(--spacing-md);">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--spacing-md);">Load Data</h2>
                <div style="background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; padding: var(--spacing-sm); margin-bottom: var(--spacing-md); font-size: 0.875rem; color: #065f46;">
                    <strong>‚úÖ Fully Fixed:</strong><br/>
                    ‚Ä¢ Uses ref for reliable index tracking (no more duplicates)<br/>
                    ‚Ä¢ CSV parser handles quoted fields<br/>
                    ‚Ä¢ Console logging shows exact progress
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                    <div style="border: 2px dashed var(--color-border); border-radius: 12px; padding: var(--spacing-lg); text-align: center;">
                        <input type="file" id="fileInput" accept=".csv,.tsv,.txt" style="display: none;">
                        <button onclick="document.getElementById('fileInput').click()" class="btn-primary-research">Choose CSV File</button>
                    </div>
                    <div style="border: 2px dashed var(--color-border); border-radius: 12px; padding: var(--spacing-md);">
                        <textarea id="pastedData" rows="8" placeholder="Or paste CSV data..." style="width: 100%; font-size: 0.75rem; font-family: monospace;"></textarea>
                    </div>
                </div>
                <div id="loadButtonContainer" style="display: none;">
                    <button onclick="loadCompanies()" class="btn-success">Load & Clean Data</button>
                </div>
            </div>

            <!-- Research Section -->
            <div id="researchSection" style="display: none;">
                <!-- Stats -->
                <div class="stats-grid-research">
                    <div class="stat-card-research">
                        <p>Researched</p>
                        <p id="statTotal">0/0</p>
                    </div>
                    <div class="stat-card-research">
                        <p>Acquired</p>
                        <p id="statAcquired" style="color: #10b981;">0</p>
                    </div>
                    <div class="stat-card-research">
                        <p>Active</p>
                        <p id="statActive" style="color: #2563eb;">0</p>
                    </div>
                    <div class="stat-card-research">
                        <p>High Score</p>
                        <p id="statHighScore" style="color: #7c3aed;">0</p>
                    </div>
                    <div class="stat-card-research">
                        <p>Avg Score</p>
                        <p id="statAvgScore">0</p>
                    </div>
                    <div class="stat-card-research">
                        <p>Skipped</p>
                        <p id="statSkipped" style="color: #f59e0b;">0</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="research-controls">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                        <div>
                            <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem;">Progress</h2>
                            <p style="font-size: 0.875rem; color: var(--color-text-light);">
                                <span id="progressText">Ready: 0/0 complete</span>
                                <span id="timerDisplay" style="margin-left: 0.5rem; color: #2563eb; font-weight: 600; display: none;"></span>
                                <span id="autoStatus" style="margin-left: 0.5rem; color: #10b981; font-weight: 600; display: none;">‚óè Running</span>
                            </p>
                        </div>
                        <div style="display: flex; gap: var(--spacing-xs); align-items: center; flex-wrap: wrap;">
                            <select id="delaySelect" style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.875rem;" disabled>
                                <option value="10">10s</option>
                                <option value="15">15s</option>
                                <option value="20">20s</option>
                            </select>
                            <button id="autoResearchBtn" onclick="toggleAutoResearch()" class="btn-success">‚ñ∂ Start</button>
                            <button id="nextBtn" onclick="researchNext()" class="btn-primary-research">üîç Next</button>
                            <button id="skipBtn" onclick="skipCurrent()" class="btn-primary-research" style="background: #f59e0b;" disabled>‚è≠ Skip</button>
                            <button id="exportBtn" onclick="exportResults()" class="btn-primary-research" style="background: #7c3aed;">‚¨á Export</button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div id="statusMessage" class="status-message" style="display: none;"></div>
                    <div id="longWaitWarning" style="display: none; margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; color: #92400e; font-size: 0.875rem;">
                        ‚ö† Taking long - click Skip if stuck
                    </div>
                </div>

                <!-- Results -->
                <div id="resultsContainer" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                        <h2 style="font-size: 1.125rem; font-weight: 600;">Latest Results</h2>
                        <details style="font-size: 0.875rem;">
                            <summary style="cursor: pointer; color: #2563eb; font-weight: 500;">How is the score calculated?</summary>
                            <div style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--color-bg-light); border-radius: 8px; font-size: 0.75rem; color: var(--color-text); line-height: 1.6;">
                                <p><strong>Scoring System (0-10):</strong></p>
                                <p><strong>0:</strong> Defunct - Company is shut down or no information found</p>
                                <p><strong>1-3:</strong> Active but unfunded - Operating with a website but no public funding or traction signals</p>
                                <p><strong>4-5:</strong> Early stage - Raised seed funding OR showing traction (customers, revenue, press coverage)</p>
                                <p><strong>6-7:</strong> Growth stage - Raised Series A or later, OR strong growth signals (major customers, significant revenue)</p>
                                <p><strong>8-9:</strong> Scale stage - Raised Series B+, OR clear path to exit (large revenue, major partnerships)</p>
                                <p><strong>10:</strong> Exited - Successfully acquired by another company OR completed IPO</p>
                                <p style="margin-top: 0.5rem; color: var(--color-text-light); font-style: italic;">Note: Scoring is generous. Active companies with minimal info get at least 1-3 points.</p>
                            </div>
                        </details>
                    </div>
                    <div id="resultsList" class="results-list"></div>
                </div>
            </div>

            <!-- Opal Integration Section -->
            <div id="opalSection" style="background: white; border-radius: 12px; padding: var(--spacing-lg); border: 1px solid var(--color-border); margin-top: var(--spacing-md); display: none;">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: var(--spacing-md);">Opal Analysis Tool</h2>
                <div style="border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; min-height: 600px;">
                    <iframe 
                        id="opal-iframe" 
                        style="width: 100%; height: 800px; border: none;"
                        sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-modals allow-storage-access-by-user-activation allow-downloads allow-top-navigation" 
                        allow="clipboard-read; clipboard-write; microphone; camera"
                        src="https://opal.google/?flow=drive:/1CiPPj0L03CD8zowmemzuZiO2DVG0rsbZ&shared&mode=app">
                    </iframe>
                </div>
                <p style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--color-text-light); text-align: center;">
                    Opal analysis tool loaded above. If the content doesn't appear, you may need to authenticate or check the Opal flow access.
                </p>
            </div>

            <!-- Info Box -->
            <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 12px; padding: var(--spacing-md); margin-top: var(--spacing-md);">
                <p style="font-weight: 700; color: #065f46; margin-bottom: var(--spacing-xs);">üõ°Ô∏è Reliability Features:</p>
                <ul style="font-size: 0.875rem; color: #065f46; line-height: 1.8;">
                    <li>‚úÖ <strong>30-second timeout</strong> on every request - never hangs indefinitely</li>
                    <li>‚úÖ <strong>Automatic skip</strong> on errors - always moves to next company</li>
                    <li>‚úÖ <strong>CBInsights/PitchBook priority</strong> - searches these databases first</li>
                    <li>‚úÖ <strong>File upload support</strong> - cleaner data loading</li>
                    <li>‚úÖ <strong>Smart deduplication</strong> - pre-processes data before research</li>
                    <li>‚úÖ <strong>Never stops</strong> - guaranteed to process all companies</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Authentication
        const CORRECT_EMAIL = 'steve.r.hayton@gmail.com';
        const CORRECT_PASSWORD = 'riyan88';

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            if (email === CORRECT_EMAIL && password === CORRECT_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('researchContent').classList.add('active');
                sessionStorage.setItem('authenticated', 'true');
            } else {
                errorMessage.textContent = 'Invalid email or password';
                errorMessage.classList.add('show');
            }
        });

        // Check if already authenticated
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('researchContent').classList.add('active');
        }

        // Research Tool State
        let companies = [];
        let researching = false;
        let isRunning = false;
        let results = [];
        let delay = 10;
        let timer = 0;
        let timerInterval = null;
        let abortController = null;
        let runningRef = false;
        let nextIndexRef = { current: 0 }; // Track actual progress with ref
        let currentCompanyName = '';

        // File upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('pastedData').value = e.target.result;
                updateLoadButton();
            };
            reader.readAsText(file);
        });

        document.getElementById('pastedData').addEventListener('input', updateLoadButton);

        function updateLoadButton() {
            const data = document.getElementById('pastedData').value;
            if (data.trim()) {
                document.getElementById('loadButtonContainer').style.display = 'block';
            } else {
                document.getElementById('loadButtonContainer').style.display = 'none';
            }
        }

        function parseCSVLine(line, delimiter = ',') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').map(line => line.replace(/\r$/, ''));
            if (lines.length < 2) return [];
            
            // Detect delimiter
            const firstLine = lines[0];
            const delimiter = firstLine.includes('\t') ? '\t' : ',';
            
            const headers = delimiter === ',' ? parseCSVLine(lines[0], ',') : lines[0].split('\t');
            
            const parsed = lines.slice(1).map((line) => {
                const values = delimiter === ',' ? parseCSVLine(line, ',') : line.split('\t');
                const company = {};
                headers.forEach((header, i) => {
                    company[header.trim()] = values[i]?.trim() || '';
                });
                return company;
            }).filter(c => c['Company Name'] && c['Company Name'] !== '');

            return parsed;
        }

        function cleanData(companies) {
            const unique = {};
            
            companies.forEach(company => {
                const url = company['Company URL'];
                const name = company['Company Name'];
                const normalizedUrl = url ? url.toLowerCase()
                    .replace(/^https?:\/\/(www\.)?/, '')
                    .replace(/\/$/, '')
                    .split('?')[0] : '';
                
                const key = normalizedUrl || name.toLowerCase().trim();
                if (!unique[key]) {
                    unique[key] = company;
                } else if (url && !unique[key]['Company URL']) {
                    unique[key] = company;
                }
            });

            return Object.values(unique);
        }

        function loadCompanies() {
            const pastedData = document.getElementById('pastedData').value;
            const parsed = parseCSV(pastedData);
            companies = cleanData(parsed);
            nextIndexRef.current = 0;
            results = [];
            
            document.getElementById('dataLoadingSection').style.display = 'none';
            document.getElementById('researchSection').style.display = 'block';
            document.getElementById('resetBtn').style.display = 'block';
            updateStats();
            updateUI();
            
            console.log('Loaded companies:', companies.map(c => c['Company Name']));
        }

        function resetTool() {
            stopAutoResearch();
            companies = [];
            nextIndexRef.current = 0;
            results = [];
            document.getElementById('pastedData').value = '';
            document.getElementById('dataLoadingSection').style.display = 'block';
            document.getElementById('researchSection').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';
            timer = 0;
            currentCompanyName = '';
            stopTimer();
            updateUI();
        }

        function startTimer() {
            timer = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer++;
                document.getElementById('timerDisplay').textContent = `‚Ä¢ ${timer}s`;
                document.getElementById('timerDisplay').style.display = 'inline';
                if (timer > 25 && researching) {
                    document.getElementById('longWaitWarning').style.display = 'block';
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timer = 0;
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('longWaitWarning').style.display = 'none';
        }

        async function fetchWithTimeout(url, options, timeout = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout after 30 seconds');
                }
                throw error;
            }
        }

        let apiKey = sessionStorage.getItem('anthropic_api_key');

        async function researchCompany(company) {
            const companyName = company['Company Name'];
            const companyUrl = company['Company URL'];
            const accelerator = company['Accelerator'];
            
            if (!apiKey) {
                apiKey = prompt('Please enter your Anthropic API key:');
                if (apiKey) {
                    sessionStorage.setItem('anthropic_api_key', apiKey);
                } else {
                    updateStatus('‚ùå API key required to research companies');
                    return {
                        ...company,
                        company_name: companyName,
                        status: 'error',
                        notes: 'API key not provided',
                        score: 0,
                        researched: true,
                        error: 'API key required'
                    };
                }
            }
            
            console.log('Researching company:', companyName);
            currentCompanyName = companyName;
            updateStatus(`Researching: ${companyName}`);
            startTimer();
            
            abortController = new AbortController();
            
            try {
                const timeoutId = setTimeout(() => {
                    console.log('Timeout triggered for:', companyName);
                    abortController?.abort();
                }, 30000);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    signal: abortController.signal,
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }],
                        messages: [{
                            role: 'user',
                            content: `Research the company named "${companyName}"${companyUrl ? ` with website ${companyUrl}` : ''} from ${accelerator} accelerator.

CRITICAL: You must research "${companyName}" specifically, not any other company.

Search strategy:
1. First try: "site:cbinsights.com ${companyName}" OR "site:pitchbook.com ${companyName}"
2. Then: "${companyName} funding" "${companyName} acquisition"

Find: funding, acquisition, status, achievements.

Scoring: 0=defunct, 1-3=active/no funding, 4-5=seed, 6-7=Series A+, 8-9=Series B+, 10=acquired/IPO

Return ONLY JSON (no markdown):
{
  "company_name": "${companyName}",
  "status": "active",
  "total_funding": "amount",
  "latest_round": "details",
  "acquisition": "None",
  "score": 5,
  "notes": "brief summary",
  "sources": ["url1"]
}`
                        }]
                    })
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`API ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const fullText = data.content?.map(item => item.type === 'text' ? item.text : '').filter(Boolean).join('\n') || '';
                
                console.log(`Response for ${companyName}:`, fullText.substring(0, 150));
                
                const jsonMatch = fullText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No JSON in response');
                
                const parsed = JSON.parse(jsonMatch[0].replace(/```json\n?/g, '').replace(/```\n?/g, ''));
                parsed.score = parseInt(parsed.score) || 0;
                
                console.log('Parsed result:', { name: parsed.company_name, score: parsed.score });
                
                stopTimer();
                currentCompanyName = '';
                updateStatus(`‚úì ${parsed.company_name} (${parsed.score}/10)`);
                
                return { ...company, ...parsed, researched: true, research_date: new Date().toISOString() };
                
            } catch (error) {
                stopTimer();
                currentCompanyName = '';
                console.error(`ERROR for ${companyName}:`, error.message);
                updateStatus(`‚ö† Skipped: ${companyName} - ${error.message}`);
                
                return {
                    ...company,
                    company_name: companyName,
                    status: 'error',
                    notes: `Skipped: ${error.message}`,
                    total_funding: 'Unknown',
                    latest_round: 'None',
                    acquisition: 'None',
                    score: 0,
                    researched: true,
                    error: error.message
                };
            }
        }

        async function researchNext() {
            const currentIdx = nextIndexRef.current;
            
            if (currentIdx >= companies.length) {
                stopAutoResearch();
                updateStatus('All complete!');
                console.log('All companies researched');
                return false;
            }

            const company = companies[currentIdx];
            console.log(`Processing company ${currentIdx + 1}/${companies.length}: ${company['Company Name']}`);
            
            setResearching(true);
            
            try {
                const result = await researchCompany(company);
                results.push(result);
                nextIndexRef.current = currentIdx + 1; // Increment ref immediately
                console.log(`Completed. Next index will be: ${nextIndexRef.current}`);
                updateStats();
                updateUI();
                renderResults();
                return true;
            } catch (error) {
                console.error('CRITICAL:', error);
                results.push({
                    ...company,
                    company_name: company['Company Name'],
                    status: 'error',
                    notes: 'Critical error',
                    score: 0
                });
                nextIndexRef.current = currentIdx + 1; // Increment ref even on error
                return true;
            } finally {
                setResearching(false);
            }
        }

        function setResearching(value) {
            researching = value;
            updateUI();
        }

        function skipCurrent() {
            const currentIdx = nextIndexRef.current;
            if (currentIdx >= companies.length) return;
            
            const company = companies[currentIdx];
            console.log('Manual skip triggered for:', company['Company Name']);
            
            if (abortController) {
                abortController.abort();
            }
            stopTimer();
            
            results.push({
                ...company,
                company_name: company['Company Name'],
                status: 'error',
                notes: 'Manually skipped',
                total_funding: 'Unknown',
                latest_round: 'None',
                acquisition: 'None',
                score: 0,
                researched: true,
                error: 'Manually skipped'
            });
            
            nextIndexRef.current = currentIdx + 1;
            setResearching(false);
            updateStatus('Skipped - ready for next');
            updateStats();
            updateUI();
            renderResults();
        }

        async function autoResearchLoop() {
            if (!runningRef) {
                console.log('Auto-research stopped (runningRef = false)');
                return;
            }
            
            const currentIdx = nextIndexRef.current;
            console.log(`Auto-research loop: will process company ${currentIdx + 1}/${companies.length}`);
            
            if (currentIdx >= companies.length) {
                console.log('All companies completed');
                stopAutoResearch();
                return;
            }
            
            const success = await researchNext();
            
            if (success && runningRef && nextIndexRef.current < companies.length) {
                delay = parseInt(document.getElementById('delaySelect').value);
                updateStatus(`Waiting ${delay}s...`);
                console.log(`Waiting ${delay}s before next company (next will be #${nextIndexRef.current + 1})...`);
                setTimeout(() => {
                    if (runningRef) {
                        autoResearchLoop();
                    }
                }, delay * 1000);
            } else {
                console.log('Auto-research complete or stopped');
                stopAutoResearch();
            }
        }

        function startAutoResearch() {
            console.log('Starting auto-research from index:', nextIndexRef.current);
            isRunning = true;
            runningRef = true;
            autoResearchLoop();
        }

        function stopAutoResearch() {
            console.log('Stopping auto-research...');
            isRunning = false;
            runningRef = false;
            if (abortController) {
                abortController.abort();
            }
            stopTimer();
            setResearching(false);
        }

        function toggleAutoResearch() {
            if (isRunning) {
                stopAutoResearch();
            } else {
                startAutoResearch();
            }
            updateUI();
        }

        function updateStats() {
            const stats = {
                total: results.length,
                acquired: results.filter(r => r.status === 'acquired').length,
                active: results.filter(r => r.status === 'active').length,
                inactive: results.filter(r => r.status === 'inactive').length,
                errors: results.filter(r => r.status === 'error').length,
                avgScore: results.length > 0 ? (results.reduce((sum, r) => sum + (r.score || 0), 0) / results.length).toFixed(1) : 0,
                highScorers: results.filter(r => r.score >= 7).length
            };

            document.getElementById('statTotal').textContent = `${stats.total}/${companies.length}`;
            document.getElementById('statAcquired').textContent = stats.acquired;
            document.getElementById('statActive').textContent = stats.active;
            document.getElementById('statHighScore').textContent = stats.highScorers;
            document.getElementById('statAvgScore').textContent = stats.avgScore;
            document.getElementById('statSkipped').textContent = stats.errors;
            
            const progress = companies.length > 0 ? (results.length / companies.length) * 100 : 0;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateUI() {
            const progressTextEl = document.getElementById('progressText');
            if (currentCompanyName) {
                progressTextEl.textContent = `Researching: ${currentCompanyName}`;
            } else {
                progressTextEl.textContent = `Ready: ${results.length}/${companies.length} complete`;
            }
            
            const nextBtn = document.getElementById('nextBtn');
            const autoBtn = document.getElementById('autoResearchBtn');
            const skipBtn = document.getElementById('skipBtn');
            const exportBtn = document.getElementById('exportBtn');
            const delaySelect = document.getElementById('delaySelect');
            
            nextBtn.disabled = researching || isRunning || nextIndexRef.current >= companies.length;
            autoBtn.disabled = nextIndexRef.current >= companies.length;
            skipBtn.disabled = !researching && !isRunning;
            exportBtn.disabled = results.length === 0;
            delaySelect.disabled = isRunning;
            
            if (isRunning) {
                autoBtn.textContent = '‚è∏ Pause';
                autoBtn.className = 'btn-danger';
                document.getElementById('autoStatus').style.display = 'inline';
            } else {
                autoBtn.textContent = '‚ñ∂ Start';
                autoBtn.className = 'btn-success';
                document.getElementById('autoStatus').style.display = 'none';
            }
        }

        function updateStatus(message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
        }

        function renderResults() {
            if (results.length === 0) return;
            
            document.getElementById('resultsContainer').style.display = 'block';
            const resultsList = document.getElementById('resultsList');
            const recentResults = results.slice().reverse().slice(0, 15);
            
            resultsList.innerHTML = recentResults.map(result => {
                const score = result.score || 0;
                let scoreClass = 'score-none';
                if (score >= 8) scoreClass = 'score-high';
                else if (score >= 6) scoreClass = 'score-medium';
                else if (score >= 4) scoreClass = 'score-low';
                else if (score >= 1) scoreClass = 'score-very-low';
                
                return `
                    <div class="result-item">
                        <div class="result-header">
                            <strong>${result.company_name || result['Company Name']}</strong>
                            <span class="score-badge ${scoreClass}">${score}/10</span>
                            ${result.error ? `<span style="color: #f59e0b; font-size: 0.75rem;">‚ö† ${result.error}</span>` : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem; color: var(--color-text-light); margin: 0.5rem 0;">
                            <div><strong>Funding:</strong> ${result.total_funding || 'Unknown'}</div>
                            <div><strong>Status:</strong> ${result.status || 'Unknown'}</div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--color-text);">${result.notes || ''}</p>
                    </div>
                `;
            }).join('');
        }

        function exportResults() {
            const csv = [
                ['Company Name', 'Company URL', 'Accelerator', 'Industry Tag', 'Team Size', 'Status', 'Total Funding', 'Latest Round', 'Acquisition', 'Score', 'Notes', 'Error Message', 'Sources'].join('\t'),
                ...results.map(r => [
                    r.company_name || r['Company Name'],
                    r['Company URL'] || '',
                    r.Accelerator || '',
                    r['Industry Tag'] || '',
                    r['Team Size'] || '',
                    r.status || '',
                    r.total_funding || '',
                    r.latest_round || '',
                    r.acquisition || '',
                    r.score || 0,
                    (r.notes || '').replace(/\t/g, ' ').replace(/\n/g, ' '),
                    r.error || '',
                    (r.sources || []).join('; ')
                ].join('\t'))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vbf-research-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function showOpalSection() {
            const opalSection = document.getElementById('opalSection');
            if (opalSection.style.display === 'none' || !opalSection.style.display) {
                opalSection.style.display = 'block';
                opalSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                opalSection.style.display = 'none';
            }
        }
    </script>
</body>
</html>

